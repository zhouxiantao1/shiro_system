<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.polly.dao.UserDao">
    
	<sql id="columns">
		id,
		username,
		password,
		salt
	</sql>
	
	<!-- 根据id查询 -->
	<select id="findOne" resultType="com.example.polly.enty.User">
		SELECT
			<include refid="columns"/>
		FROM sys_user WHERE id = #{id}
	</select>
	
	<!-- 根据用户名查询 -->
	<select id="findByUsername" resultType="com.example.polly.enty.User">
		SELECT
			<include refid="columns"/>
		FROM sys_user WHERE username = #{username}
	</select>
	
	<!-- 查询用户列表-->
	<select id="findList" resultType="com.example.polly.enty.User">
		SELECT
			<include refid="columns"/>
		FROM sys_user
		<where>
			<if test="username != null and username !='' ">username like '%' || #{username} || '%'</if>
		</where>
	</select>
	
	<!-- 根据用户名查询角色 -->
	<select id="findRoles" resultType="java.lang.String">
		select a.role from sys_role a inner join sys_user_role b ON a.id=b.roleId INNER JOIN sys_user c on c.id=b.userId and c.username = #{username}
	</select>
	
	<!-- 根据用户名查询权限 -->
	<select id="findPermissions" resultType="java.lang.String">
		select a.permission from sys_permission a 
			INNER JOIN sys_role_permission b on a.id = b.permissionId 
			INNER JOIN sys_user_role c on b.roleId =c.roleId 
			INNER JOIN  sys_user d on d.id =c.userId and d.username = #{username}
	</select>
    
	<!-- 添加用户角色 -->
	<insert id="correlationRoles">
		INSERT INTO sys_user_role(
			id, 
			userId, 
			roleId
		) VALUES (
			#{id},
			#{userId},
			#{roleId}
		)
	</insert>
	
	<!-- 移除关联 -->
	<delete id="uncorrelationRoles">
     delete from sys_user_role
     <where>
          userId = #{userId} and roleIds = #{roleIds}
      </where>
   </delete>
	
	<insert id="createUser">
		INSERT INTO sys_user(
			id, 
			username, 
			password,
			salt
		) VALUES (
			#{id},
			#{username},
			#{password},
			#{salt}
		)
	</insert>
	
	<update id="updateUser">
        update sys_user
        <set>
           <if test="username != null and username !='' ">username = #{username},</if>
           <if test="password != null and password !='' ">password = #{password},</if>
           <if test="salt != null and salt !='' ">salt = #{salt},</if>
        </set>
        <where>
          id = #{id}
        </where>
   </update>
   
   <delete id="deleteUser">
     delete from sys_user
     <where>
          id = #{id}
       </where>
   </delete>
	
</mapper>